version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "üöÄ AMPLIFY BUILD - FIXING DEPLOYMENT ISSUES"
        - echo "Node: $(node --version) | NPM: $(npm --version)"
        - echo "üîç Environment Variables Check:"
        - 'test -n "$DATABASE_URL" && echo "‚úÖ DATABASE_URL" || (echo "‚ùå DATABASE_URL MISSING" && exit 1)'
        - 'test -n "$NEXTAUTH_SECRET" && echo "‚úÖ NEXTAUTH_SECRET" || (echo "‚ùå NEXTAUTH_SECRET MISSING" && exit 1)'
        - 'test -n "$S3_ACCESS_KEY_ID" && echo "‚úÖ S3_ACCESS_KEY_ID" || (echo "‚ùå S3_ACCESS_KEY_ID MISSING" && exit 1)'
        - 'test -n "$GOOGLE_CLIENT_ID" && echo "‚úÖ GOOGLE_CLIENT_ID" || echo "‚ö†Ô∏è GOOGLE_CLIENT_ID missing"'
        - 'test -n "$STRIPE_SECRET_KEY" && echo "‚úÖ STRIPE_SECRET_KEY" || echo "‚ö†Ô∏è STRIPE_SECRET_KEY missing"'
        - echo "üì¶ Installing dependencies..."
        - npm ci --production=false --no-audit --no-fund
        - echo "üîß Generating Prisma client..."
        - npx prisma generate
        - echo "‚úÖ PreBuild completed"
    build:
      commands:
        - echo "üèóÔ∏è Building Next.js for Amplify hosting..."
        - export NODE_OPTIONS="--max-old-space-size=4096"
        - npm run build
        - echo "‚úÖ Build completed successfully"
    postBuild:
      commands:
        - echo "üì¶ Post-build cleanup and verification..."
        - echo "Build artifacts created:"
        - ls -la .next/
        - echo "‚úÖ Ready for deployment"
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
